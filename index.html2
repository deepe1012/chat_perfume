<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Nostalgia Perfume Chatbot Embed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    }

    /* í”Œë¡œíŒ… ë²„íŠ¼ */
    .chat-launcher {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 54px;
      height: 54px;
      border-radius: 50%;
      border: none;
      background: #d76da4;
      color: #fff;
      font-size: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,0.18);
      z-index: 9999;
    }

    /* íŒì—… ì „ì²´ */
    .chat-popup {
      position: fixed;
      bottom: 84px;
      right: 20px;
      width: 360px;
      max-height: 600px;
      background: #ffffff;
      border-radius: 16px;
      border: 2px solid #f4d0e4;
      display: none;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 10px 26px rgba(0,0,0,0.2);
      z-index: 9998;
    }

    .chat-header {
      padding: 10px 14px 8px;
      background: #d76da4;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
    }

    .chat-header-title {
      font-weight: 600;
    }

    .chat-header-sub {
      font-size: 11px;
      opacity: 0.85;
      margin-top: 2px;
    }

    .chat-header-left {
      display: flex;
      flex-direction: column;
    }

    .chat-header-close {
      background:none;
      border:none;
      color:#fff;
      font-size:18px;
      cursor:pointer;
    }

    .chat-window {
      flex: 1;
      padding: 10px 10px 4px;
      overflow-y: auto;
      background: #fffdfd;
    }

    .helper-text {
      font-size: 11px;
      color: #b37aa0;
      margin: 0 4px 6px;
      padding: 4px 6px;
      border-radius: 6px;
      background: #fff4fb;
    }

    .msg-row {
      margin-bottom: 10px;
      display: flex;
    }
    .msg-row.user { justify-content: flex-end; }

    .msg-bubble {
      padding: 10px 13px;
      max-width: 80%;
      border-radius: 12px;
      white-space: pre-line;
      font-size: 13px;
      line-height: 1.45;
    }

    .msg-bubble.user {
      background: #ffddee;
      border-bottom-right-radius: 2px;
    }
    .msg-bubble.bot {
      background: #f7e8f3;
      border-bottom-left-radius: 2px;
    }

    .msg-bubble.bot b {
      font-size: 13px;
    }

    .quick-menu {
      padding: 6px 8px 4px;
      border-top: 1px solid #f5d7e7;
      border-bottom: 1px solid #f5d7e7;
      background:#fffafc;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }

    .quick-chip {
      border:none;
      border-radius:999px;
      padding:4px 9px;
      font-size:11px;
      background:#f3e0ee;
      color:#7c4e67;
      cursor:pointer;
      white-space:nowrap;
    }

    .input-area {
      display: flex;
      background: #ffffff;
    }

    .input-area input {
      flex: 1;
      padding: 10px;
      border: none;
      font-size: 13px;
      outline: none;
    }

    .input-area button {
      width: 80px;
      border: none;
      background: #d76da4;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
    }

    .typing {
      font-size: 11px;
      color:#8e6781;
      margin-left:4px;
    }

    .pill-link {
      display:inline-block;
      margin-top:6px;
      padding:4px 8px;
      border-radius:999px;
      background:#ffffff;
      border:1px solid #e5bdd8;
      font-size:11px;
      text-decoration:none;
      color:#b0598d;
    }
  </style>
</head>
<body>

<button class="chat-launcher" id="chat-launcher">ğŸ’¬</button>

<div class="chat-popup" id="chat-popup">
  <div class="chat-header">
    <div class="chat-header-left">
      <span class="chat-header-title">ì¶”ì–µì˜ í–¥ìˆ˜ ì±—ë´‡</span>
      <span class="chat-header-sub">ë‹¹ì‹ ì˜ ê·¸ë•Œ ê·¸ ìˆœê°„ì„ í–¥ìœ¼ë¡œ ì°¾ì•„ë“œë¦´ê²Œìš”</span>
    </div>
    <button class="chat-header-close" id="chat-close">Ã—</button>
  </div>

  <div id="chat-window" class="chat-window">
    <div class="helper-text">
      ì˜ˆ: "ë¹„ ì˜¤ëŠ” ë‚  í™ëƒ„ìƒˆ", "4ì›” ì²«ì‚¬ë‘ ëŠë‚Œ", "ì—„ë§ˆì˜ ë¶€ì—Œ ê°™ì€ í–¥", "ë¸Œëœë“œ ì†Œê°œí•´ì¤˜"
    </div>
  </div>

  <div class="quick-menu">
    <button class="quick-chip" data-text="ë¸Œëœë“œ ì†Œê°œí•´ì¤˜">ë¸Œëœë“œ ì†Œê°œ</button>
    <button class="quick-chip" data-text="ë”°ëœ»í•˜ê³  ì§‘ ê°™ì€ í–¥ ì¶”ì²œí•´ì¤˜">ë”°ëœ»í•œ ì§‘ í–¥</button>
    <button class="quick-chip" data-text="ë²šê½ƒ ê°™ì€ ì²«ì‚¬ë‘ í–¥ ì¶”ì²œí•´ì¤˜">ì²«ì‚¬ë‘/ë²šê½ƒ</button>
    <button class="quick-chip" data-text="ë¹„ ì˜¤ëŠ” ë‚  í™ëƒ„ìƒˆ ë‚˜ëŠ” í–¥ ì¶”ì²œí•´ì¤˜">ë¹„ ì˜¤ëŠ” ë‚ </button>
    <button class="quick-chip" data-text="ì†Œí’ ê°€ëŠ” ë‚  ëŠë‚Œ í–¥ ì¶”ì²œí•´ì¤˜">ì†Œí’/ì—¬í–‰</button>
    <button class="quick-chip" data-text="ìš´ë™ì¥ í™ëƒ„ìƒˆ ë‚˜ëŠ” í–¥ ì¶”ì²œí•´ì¤˜">ìš´ë™ì¥</button>
    <button class="quick-chip" data-text="êµ¬ë©ê°€ê²Œ ì‚¬íƒ• ëŠë‚Œ í–¥ ì¶”ì²œí•´ì¤˜">êµ¬ë©ê°€ê²Œ ì‚¬íƒ•</button>
    <button class="quick-chip" data-text="í–¥ìˆ˜ ë¦¬ìŠ¤íŠ¸ ë³´ì—¬ì¤˜">í–¥ìˆ˜ ëª©ë¡</button>
  </div>

  <div class="input-area">
    <input id="user-input" placeholder="ì›í•˜ëŠ” í–¥ ëŠë‚Œì´ë‚˜ ì¶”ì–µì„ ì ì–´ì£¼ì„¸ìš”" />
    <button id="send-btn">ì „ì†¡</button>
  </div>
</div>

<script>
  // ==========================
  // 1. í–¥ìˆ˜ ë°ì´í„° (12ì¢…)
  // ==========================
  // âš ï¸ ë‚˜ì¤‘ì— ì‹¤ì œ ìƒí’ˆ ë§í¬ë¥¼ ë„£ê³  ì‹¶ìœ¼ë©´
  //    ì•„ë˜ ê° ê°ì²´ì˜ link: "" ë¶€ë¶„ì—
  //    ì¹´í˜24 ìƒí’ˆ URLì„ ì±„ì›Œ ë„£ìœ¼ë©´ ë¨.
  const perfumes = [
    {
      id: 1,
      code: "NP01",
      name: "Seize Heures en Classe",
      krName: "ì˜¤í›„ 4ì‹œì˜ êµì‹¤",
      storyShort: "ë¶„í•„ ê°€ë£¨ê°€ í–‡ì‚´ì— ë°˜ì§ì´ë˜ ê³ ìš”í•œ ì˜¤í›„ 4ì‹œ, ì¹œêµ¬ë“¤ê³¼ ë‚˜ëˆ  ë¨¹ë˜ ìš°ìœ ì™€ ë‚˜ë¬´ ì±…ìƒ ëƒ„ìƒˆê°€ ì„ì¸ í¬ê·¼í•œ êµì‹¤ì˜ ê³µê¸°.",
      notes: ["í™”ì´íŠ¸ ë¨¸ìŠ¤í¬", "ìš°ë””", "ë°”ë‹ë¼"],
      moodKeywords: ["êµì‹¤","ë¶„í•„","í–‡ì‚´","ìš°ìœ ","ë‚˜ë¬´ì±…ìƒ","í¬ê·¼","ë”°ëœ»","ìˆœìˆ˜","ì¹œêµ¬","ìˆ˜ë‹¤"],
      tags: ["ë”°ëœ»í•¨","í•™êµ","í¬ê·¼í•œì¼ìƒ"],
      link: "" // ì˜ˆ: "https://yourshop.com/product/np01"
    },
    {
      id: 2,
      code: "NP02",
      name: "Lettre en Origami",
      krName: "ìƒ‰ì¢…ì´ í¸ì§€",
      storyShort: "ì†ë•Œ ë¬»ì€ ìƒ‰ì¢…ì´ë¥¼ ì ‘ìœ¼ë©° ì „í•˜ë˜ ë¹„ë°€ ë©”ì‹œì§€, ë°”ìŠ¤ë½ê±°ë¦¬ëŠ” ì¢…ì´ì™€ ì‰í¬ ëƒ„ìƒˆê°€ ë‚¨ì•„ ìˆëŠ” ì„¤ë ˜ì˜ ìˆœê°„.",
      notes: ["í˜ì´í¼","ì•„ì´ë¦¬ìŠ¤","ì‹œíŠ¸ëŸ¬ìŠ¤"],
      moodKeywords: ["ìƒ‰ì¢…ì´","í¸ì§€","ë°”ìŠ¤ë½","ì‰í¬","ë¹„ë°€","ìš°ì •","ì„¤ë ˜"],
      tags: ["ì²«ì‚¬ë‘","ìš°ì •","ì¢…ì´í–¥"],
      link: ""
    },
    {
      id: 3,
      code: "NP03",
      name: "Cave SecrÃ¨te",
      krName: "ê³¨ëª©ê¸¸ ë ì§€í•˜ì‹¤",
      storyShort: "ë™ë„¤ ê³¨ëª© ë, ì¹œêµ¬ë“¤ê³¼ ìˆ¨ê²¨ë‘” ë¹„ë°€ ì•„ì§€íŠ¸. ìŠµê¸° ì–´ë¦° ê³µê¸°ì™€ ì½˜í¬ë¦¬íŠ¸, ë¨¼ì§€ ìŒ“ì¸ ë§Œí™”ì±… ëƒ„ìƒˆ.",
      notes: ["ë¨¸ìŠ¤í‚¤ í™ë‚´ìŒ","ì½˜í¬ë¦¬íŠ¸","ëª¨ìŠ¤"],
      moodKeywords: ["ì§€í•˜ì‹¤","ì•„ì§€íŠ¸","ê³¨ëª©ê¸¸","ë¹„ë°€","ìŠµê¸°","ì–´ë‘‘í•¨"],
      tags: ["ë¹„ë°€","ë ˆíŠ¸ë¡œ","í™ë‚´"],
      link: ""
    },
    {
      id: 4,
      code: "NP04",
      name: "Tiroir de Grand-mÃ¨re",
      krName: "í• ë¨¸ë‹ˆì˜ ì„œëì¥",
      storyShort: "ì˜¤ë˜ëœ ì¥ë¡±ì„ ì—´ ë•Œë§ˆë‹¤ í’ê¸°ë˜ í•œì§€ì™€ ë‚˜ë¬´ ëƒ„ìƒˆ, í• ë¨¸ë‹ˆì˜ ì†ë•Œ ë¬»ì€ í¸ì§€ì™€ í•œë³µì´ ë– ì˜¤ë¥´ëŠ” í–¥.",
      notes: ["íŒŒí”¼ë£¨ìŠ¤","ì‚¼ë‚˜ë¬´","ì€ì€í•œ í”Œë¡œëŸ´"],
      moodKeywords: ["í•œì§€","ì¥ë¡±","í¸ì§€","í• ë¨¸ë‹ˆ","í¬ê·¼","ê³ ì¦ˆë„‰"],
      tags: ["ê°€ì¡±","ë”°ëœ»í•¨","ì¢…ì´í–¥"],
      link: ""
    },
    {
      id: 5,
      code: "NP05",
      name: "Cuisine de Maman",
      krName: "ì—„ë§ˆì˜ ë¶€ì—Œ",
      storyShort: "í˜„ê´€ë¬¸ì„ ì—´ë©´ í’ê¸°ë˜ ë°¥ ëƒ„ìƒˆ, ì••ë ¥ë°¥ì†¥ ê¹€ê³¼ ì°¸ê¸°ë¦„ ë¹„ë¹”ë°¥ì˜ ê³ ì†Œí•¨ì´ ë‹´ê¸´ ì§‘ë°¥ì˜ ê¸°ì–µ.",
      notes: ["í† ìŠ¤í‹°ë“œ ë¼ì´ìŠ¤","ë”°ëœ»í•œ ìš°ë””","ì°¸ê¸°ë¦„"],
      moodKeywords: ["ë¶€ì—Œ","ë°¥","ë°¥ì†¥","ì§‘ë°¥","êµ¬ìˆ˜","ì—„ë§ˆ","í¸ì•ˆ"],
      tags: ["ì§‘ê°™ì€","ë”°ëœ»í•¨","ë°¥í–¥"],
      link: ""
    },
    {
      id: 6,
      code: "NP06",
      name: "Bonbons du Coin",
      krName: "êµ¬ë©ê°€ê²Œ ì‚¬íƒ•",
      storyShort: "100ì›, 200ì› ë™ì „ì„ ì¥ê³  ë‹¬ë ¤ê°€ë˜ ê³¨ëª© êµ¬ë©ê°€ê²Œ. ìœ ë¦¬ë³‘ ì† ì•Œë¡ë‹¬ë¡í•œ ì‚¬íƒ•ê³¼ ì‚¬ê³¼ë§› ë§‰ëŒ€ì‚¬íƒ•ì˜ ë‹¬ì½¤í•¨.",
      notes: ["ì• í”Œ ë¸”ë¡œì¸","ìº”ë””","ì‹œíŠ¸ëŸ¬ìŠ¤"],
      moodKeywords: ["êµ¬ë©ê°€ê²Œ","ì‚¬íƒ•","ì ¤ë¦¬","ë‹¬ì½¤","ì‚¬ê³¼","100ì›","í–‰ë³µ"],
      tags: ["ë‹¬ì½¤í•¨","ì–´ë¦°ì‹œì ˆ","ê°„ì‹"],
      link: ""
    },
    {
      id: 7,
      code: "NP07",
      name: "Romance d'Avril",
      krName: "4ì›”ì˜ ì²«ì‚¬ë‘",
      storyShort: "ë³µë„ì—ì„œ ìŠ¤ì³ ì§€ë‚˜ê°ˆê¹Œ ë‘ê·¼ëŒ€ë˜ ì‹¬ì¥, ë²šê½ƒì´ í©ë‚ ë¦¬ë˜ ë´„ë‚ ì˜ ìˆœìˆ˜í•œ ì²«ì‚¬ë‘ì˜ ë–¨ë¦¼.",
      notes: ["ì²´ë¦¬ ë¸”ë¡œì¸","í™”ì´íŠ¸ í”Œë¡œëŸ´","ì†Œí”„íŠ¸ ë¨¸ìŠ¤í¬"],
      moodKeywords: ["ë´„","ë²šê½ƒ","ì²«ì‚¬ë‘","ë–¨ë¦¼","ìª½ì§€","ì„¤ë ˜","ì²­ìˆœ"],
      tags: ["ì²«ì‚¬ë‘","í”Œë¡œëŸ´","ë´„"],
      link: ""
    },
    {
      id: 8,
      code: "NP08",
      name: "Jour de Pique-nique",
      krName: "ì†Œí’ ê°€ëŠ” ë‚ ",
      storyShort: "ë„ì‹œë½ì„ ë“¤ê³  ë– ë‚˜ë˜ ë´„ ì†Œí’, ë²„ìŠ¤ ì°½ë¬¸ ë°– ì‹ ë¡ê³¼ ê¹€ë°¥, ì‚° ì •ìƒì—ì„œ ë§ˆì‹œë˜ ì‹œì›í•œ ë¬¼ê¹Œì§€ ë‹´ì€ í–¥.",
      notes: ["ìš°ë“œ","í”„ë ˆì‹œ ì—ì–´"],
      moodKeywords: ["ì†Œí’","ë„ì‹œë½","ë²„ìŠ¤","ì‚°","ê¹€ë°¥","ì—¬í–‰ì‹œì‘"],
      tags: ["ì—¬í–‰","ì•¼ì™¸","ì‚°ëœ»"],
      link: ""
    },
    {
      id: 9,
      code: "NP09",
      name: "Vacances d'Ã‰tÃ©",
      krName: "ì—¬ë¦„ ë°”ìº‰ìŠ¤",
      storyShort: "ëª¨ë˜ì‚¬ì¥ê³¼ íŒŒë„ ì†Œë¦¬, ì„ í¬ë¦¼ê³¼ ë°”ë‹¤ ë‚´ìŒì´ ì„ì¸ ì—¬ë¦„ ê°€ì¡±ì—¬í–‰ì˜ ììœ ë¡œì›€.",
      notes: ["ì†”í‹° ì˜¤ì…˜","ì½”ì½”ë„›","ì‹œíŠ¸ëŸ¬ìŠ¤"],
      moodKeywords: ["ë°”ë‹¤","í•´ë³€","ì—¬ë¦„","ëª¨ë˜ì‚¬ì¥","ì„ í¬ë¦¼","ìˆ˜ë°•","ììœ "],
      tags: ["ë°”ë‹¤","ì—¬ë¦„","íœ´ê°€"],
      link: ""
    },
    {
      id: 10,
      code: "NP10",
      name: "Printemps au Stade",
      krName: "ìš´ë™ì¥ì˜ ë´„",
      storyShort: "í™ë¨¼ì§€ ë‚ ë¦¬ë˜ ìš´ë™íšŒ, ê³„ì£¼ì™€ ì‘ì› ì†Œë¦¬, í–‡ë³• ì•„ë˜ ìš´ë™ì¥ì˜ ì—ë„ˆì§€ê°€ ë‹´ê¸´ í–¥.",
      notes: ["ê·¸ë¼ìŠ¤","ì–´ìŠ¤","ìŠ¤í¬í‹° ë…¸íŠ¸"],
      moodKeywords: ["ìš´ë™ì¥","ìš´ë™íšŒ","í™ë¨¼ì§€","ê³„ì£¼","ì‘ì›","ì—ë„ˆì§€"],
      tags: ["ìš´ë™","í™œê¸°","í™ë‚´"],
      link: ""
    },
    {
      id: 11,
      code: "NP11",
      name: "AprÃ¨s-midi dans l'Herbe",
      krName: "í’€ë°­ ìœ„ ì˜¤í›„",
      storyShort: "í•™êµ ë’¤ëœ° í’€ë°­ì— ëˆ„ì›Œ í•˜ëŠ˜ì„ ë³´ë˜ ì˜¤í›„, ë„¤ìí´ë¡œë²„ë¥¼ ì°¾ìœ¼ë©° ë³´ëƒˆë˜ ëŠê¸‹í•œ ë°©ê³¼ í›„.",
      notes: ["ê·¸ë¦° ë¦¬í”„","í´ë¡œë²„","í”„ë ˆì‹œ í—ˆë¸Œ"],
      moodKeywords: ["í’€ë°­","í•˜ëŠ˜","í´ë¡œë²„","í™”ê´€","ë°©ê³¼í›„","ì—¬ìœ "],
      tags: ["ìì—°","ì”ì”í•¨","ê·¸ë¦°"],
      link: ""
    },
    {
      id: 12,
      code: "NP12",
      name: "MÃ©moire de Mousson",
      krName: "ì¥ë§ˆì˜ ê¸°ì–µ",
      storyShort: "ì°½ë¬¸ì„ ë‘ë“œë¦¬ë˜ ë¹—ì†Œë¦¬, ë¹„ ê·¸ì¹œ ë’¤ í”¼ì–´ì˜¤ë¥´ë˜ í™ë‚´ìŒê³¼ ì –ì€ ì•„ìŠ¤íŒ”íŠ¸ ëƒ„ìƒˆê°€ ë‹´ê¸´ ì¥ë§ˆì˜ ê¸°ì–µ.",
      notes: ["í˜íŠ¸ë¦¬ì½”ë¥´","ì˜¤ì¡´","ì•„ì¿ ì•„í‹±"],
      moodKeywords: ["ì¥ë§ˆ","ë¹„ì˜¤ëŠ”ë‚ ","ë¹—ì†Œë¦¬","í™ë‚´","ì –ì€ì•„ìŠ¤íŒ”íŠ¸","ì´‰ì´‰","ê³ ìš”"],
      tags: ["ë¹„ì˜¤ëŠ”ë‚ ","ì´‰ì´‰í•¨","í™ë‚´"],
      link: ""
    }
  ];

  // ê°ì„±/í‚¤ì›Œë“œ ìœ ì‚¬ì–´
  const synonymGroups = {
    "ë”°ëœ»": ["ë”°ëœ»","í¬ê·¼","ì§‘ê°™ì€","ì•„ëŠ‘","ë”°ì‚¬ë¡œìš´"],
    "ì²«ì‚¬ë‘": ["ì²«ì‚¬ë‘","ì„¤ë ˜","ë‘ê·¼","ë²šê½ƒ","ë²šê½ƒí–¥","ì—°ì• ì‹œì‘"],
    "ë¹„": ["ë¹„ì˜¤ëŠ”ë‚ ","ì¥ë§ˆ","ë¹„","ì´‰ì´‰","í™ëƒ„ìƒˆ","ë¹—ì†Œë¦¬"],
    "ì†Œí’": ["ì†Œí’","í”¼í¬ë‹‰","ì—¬í–‰ì‹œì‘","ì‚°í–‰","ë„ì‹œë½"],
    "ìš´ë™ì¥": ["ìš´ë™ì¥","ìš´ë™íšŒ","ì²´ìœ¡ëŒ€íšŒ","íŠ¸ë™","ê³„ì£¼","ì‘ì›"],
    "ì‚¬íƒ•": ["ì‚¬íƒ•","ì ¤ë¦¬","ìº”ë””","ë‹¬ì½¤","ì´ˆì½œë¦¿"],
    "ì§‘": ["ì§‘","ì§‘ë°¥","ë¶€ì—Œ","ì—„ë§ˆ","ì£¼ë°©"],
    "ë°”ë‹¤": ["ë°”ë‹¤","í•´ë³€","ë°”ìº‰ìŠ¤","ì—¬ë¦„íœ´ê°€","ëª¨ë˜ì‚¬ì¥","íŒŒë„","ì„œí•‘"]
  };

  function cleanText(t) {
    return t.replace(/\s+/g,"").toLowerCase();
  }

  function matchGroup(text, key) {
    const group = synonymGroups[key];
    if (!group) return false;
    return group.some(w => text.includes(w));
  }

  function findPerfumeByNameOrId(text) {
    const plain = text.replace(/\s+/g,"").toLowerCase();

    // ë²ˆí˜¸ ì°¾ê¸°
    const numMatch = text.match(/(\d+)\s*ë²ˆ/);
    if (numMatch) {
      const n = parseInt(numMatch[1], 10);
      return perfumes.find(p => p.id === n);
    }

    // ì´ë¦„ or í•œê¸€ì´ë¦„ ì¼ë¶€ë¡œ ì°¾ê¸°
    return perfumes.find(p =>
      plain.includes(p.name.replace(/\s+/g,"").toLowerCase()) ||
      plain.includes(p.krName.replace(/\s+/g,"").toLowerCase())
    );
  }

  // ==========================
  // 2. ì•Œê³ ë¦¬ì¦˜ â€“ ì ìˆ˜ ê³„ì‚°
  // ==========================
  function scorePerfumes(userText) {
    const text = cleanText(userText);

    return perfumes.map(p => {
      let score = 0;

      // ê°ì„± í‚¤ì›Œë“œ ì§ì ‘ë§¤ì¹­
      p.moodKeywords.forEach(k => {
        const ck = cleanText(k);
        if (text.includes(ck)) score += 6;
      });

      // íƒœê·¸ ê¸°ë°˜ ê°ì„± ë§¤ì¹­
      p.tags.forEach(tag => {
        const ct = cleanText(tag);
        if (text.includes(ct)) score += 4;
      });

      // í–¥ ë…¸íŠ¸ ê´€ë ¨ ë‹¨ì–´ ë§¤ì¹­
      p.notes.forEach(n => {
        const cn = cleanText(n);
        if (text.includes(cn)) score += 3;
      });

      // ìœ ì‚¬ì–´ ê·¸ë£¹ ë§¤ì¹­
      if (matchGroup(text,"ë”°ëœ»") && p.tags.includes("ë”°ëœ»í•¨")) score += 5;
      if (matchGroup(text,"ì²«ì‚¬ë‘") && p.tags.includes("ì²«ì‚¬ë‘")) score += 5;
      if (matchGroup(text,"ë¹„") && p.tags.includes("ë¹„ì˜¤ëŠ”ë‚ ")) score += 5;
      if (matchGroup(text,"ì†Œí’") && p.tags.includes("ì—¬í–‰")) score += 5;
      if (matchGroup(text,"ìš´ë™ì¥") && p.tags.includes("ìš´ë™")) score += 5;
      if (matchGroup(text,"ì‚¬íƒ•") && p.tags.includes("ë‹¬ì½¤í•¨")) score += 5;
      if (matchGroup(text,"ì§‘") && p.tags.includes("ì§‘ê°™ì€")) score += 5;
      if (matchGroup(text,"ë°”ë‹¤") && p.tags.includes("ë°”ë‹¤")) score += 5;

      // ë¶„ìœ„ê¸° í‚¤ì›Œë“œ ëŒ€ëµì  ê°€ì¤‘ì¹˜
      if (/í¬ê·¼|ì§‘ê°™|ì—„ë§ˆ|í• ë¨¸ë‹ˆ/.test(userText)) {
        if (["NP04","NP05"].includes(p.code)) score += 4;
      }
      if (/í•™êµ|êµì‹¤|ìˆ˜ì—…|ì¢…ì¹˜/.test(userText)) {
        if (["NP01","NP02","NP11","NP10"].includes(p.code)) score += 3;
      }
      if (/ì—¬ë¦„|ë°”ìº‰ìŠ¤|íœ´ê°€|í•´ë³€|ë°”ë‹¤/.test(userText)) {
        if (["NP09"].includes(p.code)) score += 4;
      }

      return { ...p, score };
    }).sort((a,b) => b.score - a.score);
  }

  // ==========================
  // 3. ë¸Œëœë“œ / ì„¤ëª… / ë¹„êµ ë“± Intent ì²˜ë¦¬
  // ==========================
  function getBrandIntroHtml() {
    return `
<b>ì¶”ì–µì˜ í–¥ìˆ˜ëŠ” ì–´ë–¤ ë¸Œëœë“œì¸ê°€ìš”?</b><br><br>
ìš°ë¦¬ëŠ” ë‹¨ìˆœíˆ ì¢‹ì€ í–¥ì„ íŒŒëŠ” ë¸Œëœë“œê°€ ì•„ë‹ˆë¼, <b>"ì‹œê°„ì˜ ì•„ì¹´ì´ë¸Œ"</b>ë¥¼ ë§Œë“œëŠ” í–¥ìˆ˜ ë ˆì´ë¸”ì´ì—ìš”.<br><br>
1990â€“2010ë…„ëŒ€ í•œêµ­ì—ì„œ ëˆ„êµ¬ë‚˜ ê³µê°í•  ìˆ˜ ìˆëŠ” ìˆœê°„ë“¤,<br>
ìƒ‰ì¢…ì´ í¸ì§€, êµ¬ë©ê°€ê²Œ ì‚¬íƒ•, ì¥ë§ˆ ë í™ë‚´, ì†Œí’ ê°€ëŠ” ë‚ ì˜ ì„¤ë ˜ ê°™ì€ ê¸°ì–µë“¤ì„ í–¥ìœ¼ë¡œ ê¸°ë¡í•˜ê³  ìˆì–´ìš”.<br><br>
ìš°ë¦¬ ìŠ¬ë¡œê±´ì€<br>
<b>"ë‹¹ì‹ ì˜ ê·¸ë•Œ ê·¸ ìˆœê°„ì„ ë‹´ì€ í–¥"</b><br>
ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ í–¥ê¸°ë¡œ êº¼ë‚´ê³  ì‹¶ë‹¤ë©´, ê·¸ë•Œì˜ ë¶„ìœ„ê¸°ë‚˜ ì¥ë©´ì„ í¸í•˜ê²Œ ë§í•´ì¤˜ìš”. âœ¨
`;
  }

  function getPerfumeListHtml() {
    const lines = perfumes.map(p => `${p.id}. ${p.krName} (${p.name})`);
    return `<b>í˜„ì¬ ì»¬ë ‰ì…˜ 12ì¢… ë¦¬ìŠ¤íŠ¸ì—ìš”.</b><br><br>${lines.join("<br>")}<br><br>ê¶ê¸ˆí•œ í–¥ì´ ìˆë‹¤ë©´<br>"3ë²ˆ ì„¤ëª…í•´ì¤˜" ë˜ëŠ” "ì¥ë§ˆì˜ ê¸°ì–µ ì„¤ëª…í•´ì¤˜" ì²˜ëŸ¼ ë¬¼ì–´ë´ë„ ì¢‹ì•„ìš”.`;
  }

  function describePerfumeHtml(p) {
    if (!p) return "ì–´ëŠ í–¥ì„ ë§í•˜ëŠ”ì§€ ì˜ ëª¨ë¥´ê² ì–´ìš”. ë²ˆí˜¸(ì˜ˆ: 3ë²ˆ)ë‚˜ ì´ë¦„ì„ ì¡°ê¸ˆ ë” ì •í™•íˆ ë§í•´ì¤„ë˜ìš”?";
    let html = `<b>${p.krName} (${p.name})</b><br><br>${p.storyShort}<br><br><b>í–¥ì˜ êµ¬ì„±</b><br>${p.notes.join(", ")}`;
    if (p.link) {
      html += `<br><a class="pill-link" href="${p.link}" target="_blank">ìƒí’ˆ ë³´ëŸ¬ê°€ê¸°</a>`;
    } else {
      // ë§í¬ëŠ” ë‚˜ì¤‘ì— ì‹œí˜¸ê°€ ë„£ì„ ì˜ˆì •ì´ë¼ ì—¬ê¸°ì„  ìƒëµ
    }
    return html;
  }

  function comparePerfumesHtml(p1, p2) {
    if (!p1 || !p2) {
      return "ë¹„êµí•  ë‘ í–¥ìˆ˜ë¥¼ ì •í™•íˆ ì•Œë ¤ì¤˜. ì˜ˆ: \"ì˜¤í›„ 4ì‹œì˜ êµì‹¤ì´ë‘ ì¥ë§ˆì˜ ê¸°ì–µ ì°¨ì´ ì•Œë ¤ì¤˜\" í˜¹ì€ \"1ë²ˆì´ë‘ 12ë²ˆ ë¹„êµí•´ì¤˜\"";
    }

    return `
<b>${p1.krName} vs ${p2.krName}</b><br><br>
â€¢ <b>${p1.krName}</b> â€“ ${p1.storyShort}<br>
í–¥ì˜ êµ¬ì„±: ${p1.notes.join(", ")}<br><br>
â€¢ <b>${p2.krName}</b> â€“ ${p2.storyShort}<br>
í–¥ì˜ êµ¬ì„±: ${p2.notes.join(", ")}<br><br>
ëŠë‚Œìœ¼ë¡œ ì •ë¦¬í•˜ë©´,<br>
<b>${p1.krName}</b>ëŠ” ${p1.tags.join(", ")} ìª½ì— ë” ê°€ê¹ê³ ,<br>
<b>${p2.krName}</b>ëŠ” ${p2.tags.join(", ")} ë¬´ë“œê°€ ë” ê°•í•´ìš”. ì§€ê¸ˆ ê¸°ë¶„ì— ë” ëŒë¦¬ëŠ” ìª½ì„ ì„ íƒí•´ë³´ëŠ” ê±¸ ì¶”ì²œí• ê²Œìš”. ğŸŒ¿
`;
  }

  function detectIntent(text) {
    const t = text.trim();

    // ë¸Œëœë“œ ì†Œê°œ
    if (/ë¸Œëœë“œ\s*ì†Œê°œ|ë¸Œëœë“œ\s*ìŠ¤í† ë¦¬|ì¶”ì–µì˜\s*í–¥ìˆ˜\s*ë­|ë¬´ìŠ¨\s*ë¸Œëœë“œ/.test(t)) {
      return { type: "brandIntro" };
    }

    // ë¦¬ìŠ¤íŠ¸
    if (/í–¥ìˆ˜\s*ëª©ë¡|í–¥ìˆ˜\s*ë¦¬ìŠ¤íŠ¸|ì „ì²´\s*í–¥ìˆ˜/.test(t)) {
      return { type: "list" };
    }

    // ë¹„êµ
    if (/ë¹„êµ|ì°¨ì´/.test(t)) {
      // ë‘ ê°œ í–¥ ë½‘ê¸° (ë²ˆí˜¸ ë˜ëŠ” ì´ë¦„)
      const nums = t.match(/(\d+)\s*ë²ˆ/g);
      let p1 = null, p2 = null;
      if (nums && nums.length >= 2) {
        const n1 = parseInt(nums[0], 10);
        const n2 = parseInt(nums[1], 10);
        p1 = perfumes.find(p => p.id === n1);
        p2 = perfumes.find(p => p.id === n2);
      } else {
        const parts = t.split(/ë‘|ê³¼|ì™€|vs|,|\/|\&/);
        if (parts.length >= 2) {
          p1 = findPerfumeByNameOrId(parts[0]);
          p2 = findPerfumeByNameOrId(parts[1]);
        }
      }
      return { type: "compare", p1, p2 };
    }

    // íŠ¹ì • í–¥ ì„¤ëª…
    if (/ì„¤ëª…|ì–´ë–¤\s*í–¥|ë¬´ìŠ¨\s*í–¥/.test(t)) {
      const target = findPerfumeByNameOrId(t);
      return { type: "describe", perfume: target };
    }

    return { type: "recommend" };
  }

  function buildRecommendationHtml(userText) {
    const ranked = scorePerfumes(userText);
    const best = ranked[0];
    if (!best || best.score === 0) {
      return `ì¡°ê¸ˆë§Œ ë” êµ¬ì²´ì ìœ¼ë¡œ ë§í•´ì¤˜!<br>ì˜ˆ: "ë¹„ ì˜¤ëŠ” ë‚  í™ëƒ„ìƒˆ", "4ì›” ì²«ì‚¬ë‘ ëŠë‚Œ", "ì—„ë§ˆì˜ ë¶€ì—Œ ê°™ì€ í¬ê·¼í•œ í–¥" ì²˜ëŸ¼ ì¥ë©´ì´ë‚˜ ê¸°ë¶„ì„ ì•Œë ¤ì£¼ë©´ ì¢‹ì•„.`;
    }
    const second = ranked[1];

    let html = `<b>ì´ëŸ° í–¥ì´ ì˜ ì–´ìš¸ë¦´ ê²ƒ ê°™ì•„ìš”.</b><br><br>`;
    html += `<b>1ìˆœìœ„ Â· ${best.krName} (${best.name})</b><br>${best.storyShort}<br>`;
    html += `<br><b>í–¥ì˜ êµ¬ì„±</b><br>${best.notes.join(", ")}`;

    if (best.link) {
      html += `<br><a class="pill-link" href="${best.link}" target="_blank">ìƒí’ˆ ë³´ëŸ¬ê°€ê¸°</a>`;
    }

    if (second && second.score > 0) {
      html += `<br><br><b>2ìˆœìœ„ë¡œëŠ”</b> ${second.krName} (${second.name}) ë„ ë¶„ìœ„ê¸°ê°€ ë¹„ìŠ·í•´ìš”.<br>`;
    }

    html += `<br><br>ë‹¤ë¥¸ ëŠë‚Œì´ ê¶ê¸ˆí•˜ë©´, "ì¢€ ë” ìƒí¼í•œ ê±¸ë¡œ", "ì¡°ê¸ˆ ë” ì”ì”í•œ í–¥ ì—†ì„ê¹Œ?" ì²˜ëŸ¼ ë‹¤ì‹œ ë§í•´ì¤˜.`;

    return html;
  }

  // ==========================
  // 4. UI / ë©”ì‹œì§€ ì²˜ë¦¬
  // ==========================
  const popup = document.getElementById("chat-popup");
  const launcher = document.getElementById("chat-launcher");
  const closeBtn = document.getElementById("chat-close");
  const chat = document.getElementById("chat-window");
  const input = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");
  const quickButtons = document.querySelectorAll(".quick-chip");

  let typingEl = null;

  function openChat() {
    popup.style.display = "flex";
  }

  function closeChat() {
    popup.style.display = "none";
  }

  launcher.onclick = () => {
    const isOpen = popup.style.display === "flex";
    if (isOpen) closeChat(); else openChat();
  };
  closeBtn.onclick = () => closeChat();

  function addMsg(text, who, isHtml=false) {
    const row = document.createElement("div");
    row.classList.add("msg-row", who);

    const bubble = document.createElement("div");
    bubble.classList.add("msg-bubble", who);

    if (isHtml) {
      bubble.innerHTML = text;
    } else {
      bubble.textContent = text;
    }

    row.appendChild(bubble);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  function showTyping() {
    if (typingEl) return;
    typingEl = document.createElement("div");
    typingEl.classList.add("typing");
    typingEl.textContent = "ì±—ë´‡ì´ í–¥ì„ ê³ ë¥´ëŠ” ì¤‘ì´ì—ìš”...";
    chat.appendChild(typingEl);
    chat.scrollTop = chat.scrollHeight;
  }

  function hideTyping() {
    if (typingEl) {
      typingEl.remove();
      typingEl = null;
    }
  }

  function getBotHtml(text) {
    const intent = detectIntent(text);

    if (intent.type === "brandIntro") {
      return getBrandIntroHtml();
    }
    if (intent.type === "list") {
      return getPerfumeListHtml();
    }
    if (intent.type === "describe") {
      return describePerfumeHtml(intent.perfume);
    }
    if (intent.type === "compare") {
      return comparePerfumesHtml(intent.p1, intent.p2);
    }
    // ê¸°ë³¸: ì¶”ì²œ
    return buildRecommendationHtml(text);
  }

  function handleSend(rawText) {
    const text = rawText.trim();
    if (!text) return;

    addMsg(text, "user", false);
    input.value = "";

    showTyping();

    setTimeout(() => {
      hideTyping();
      const replyHtml = getBotHtml(text);
      addMsg(replyHtml, "bot", true);
    }, 400);
  }

  sendBtn.onclick = () => handleSend(input.value);
  input.addEventListener("keydown", e => {
    if (e.key === "Enter") handleSend(input.value);
  });

  quickButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const t = btn.getAttribute("data-text");
      handleSend(t);
    });
  });

  // ì²« ì•ˆë‚´ ë©”ì‹œì§€
  addMsg(
    "ì•ˆë…•, ì¶”ì–µì˜ í–¥ìˆ˜ ì±—ë´‡ì´ì—ìš”.\në– ì˜¬ë¦¬ê³  ì‹¶ì€ ìˆœê°„ì´ë‚˜ ì¥ë©´ì„ ë§í•´ì£¼ë©´, ê·¸ ê¸°ì–µì— ì–´ìš¸ë¦¬ëŠ” í–¥ì„ ê³¨ë¼ì¤„ê²Œìš”.",
    "bot",
    false
  );
</script>

</body>
</html>
